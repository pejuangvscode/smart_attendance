<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/smartattendance/ui/screens/HomeScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/smartattendance/ui/screens/HomeScreen.kt" />
              <option name="originalContent" value="package com.example.smartattendance.ui.screens&#10;&#10;import androidx.compose.foundation.Canvas&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyRow&#10;import androidx.compose.foundation.lazy.itemsIndexed&#10;import androidx.compose.foundation.lazy.rememberLazyListState&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.rounded.ExitToApp&#10;import androidx.compose.material.icons.outlined.CalendarToday&#10;import androidx.compose.material.icons.outlined.Description&#10;import androidx.compose.material3.*&#10;import androidx.compose.material3.pulltorefresh.PullToRefreshBox&#10;import androidx.compose.material3.pulltorefresh.rememberPullToRefreshState&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.graphics.StrokeCap&#10;import androidx.compose.ui.graphics.drawscope.Stroke&#10;import androidx.compose.ui.graphics.graphicsLayer&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.tooling.preview.Preview&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.unit.sp&#10;import com.example.smartattendance.api.AuthApi&#10;import com.example.smartattendance.api.StatisticsApi&#10;import com.example.smartattendance.api.ScheduleApi&#10;import com.example.smartattendance.data.AttendanceStatistics&#10;import java.time.LocalTime&#10;import com.example.smartattendance.ui.theme.SmartAttendanceTheme&#10;import com.example.smartattendance.utils.SessionManager&#10;import java.time.LocalDate&#10;import java.time.format.DateTimeFormatter&#10;import java.util.Locale&#10;import kotlin.math.abs&#10;import kotlinx.coroutines.launch&#10;import androidx.compose.ui.platform.LocalContext&#10;import android.util.Log&#10;import androidx.core.view.WindowCompat&#10;import androidx.core.view.WindowInsetsControllerCompat&#10;import androidx.compose.ui.platform.LocalView&#10;import android.app.Activity&#10;import androidx.navigation.NavController&#10;import androidx.navigation.compose.rememberNavController&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HomeScreen(&#10;    user: AuthApi.User?,&#10;    sessionManager: SessionManager,&#10;    navController: NavController,&#10;    onLogout: () -&gt; Unit = {},&#10;    onDateClick: () -&gt; Unit = {},&#10;    onRequestPermission: () -&gt; Unit = {},&#10;    onBackClick: () -&gt; Unit = {}&#10;) {&#10;    val darkGray = Color(0xFF2C2D32)&#10;    val redColor = Color(0xFFE0697E)&#10;    val coroutineScope = rememberCoroutineScope()&#10;&#10;    // Set status bar color to match header&#10;    val view = LocalView.current&#10;    val window = (view.context as? Activity)?.window&#10;    window?.let {&#10;        WindowCompat.setDecorFitsSystemWindows(it, false)&#10;        val controller = WindowInsetsControllerCompat(it, view)&#10;        controller.isAppearanceLightStatusBars = true // Light icons on dark background&#10;        it.statusBarColor = 0xFF2C2D32.toInt()&#10;    }&#10;&#10;    // State untuk statistik presensi&#10;    var attendanceStatistics by remember { mutableStateOf(AttendanceStatistics.empty()) }&#10;    var isLoadingStatistics by remember { mutableStateOf(false) }&#10;    var statisticsError by remember { mutableStateOf&lt;String?&gt;(null) }&#10;&#10;    // State untuk weekly status&#10;    var weeklyStatus by remember { mutableStateOf&lt;Map&lt;String, String?&gt;&gt;(emptyMap()) }&#10;    var isLoadingWeekly by remember { mutableStateOf(false) }&#10;&#10;    // State untuk current schedule&#10;    var currentSchedule by remember { mutableStateOf&lt;CurrentScheduleInfo?&gt;(null) }&#10;    var isLoadingSchedule by remember { mutableStateOf(false) }&#10;&#10;    // State untuk pull-to-refresh&#10;    var isRefreshing by remember { mutableStateOf(false) }&#10;&#10;    // Initialize StatisticsApi and ScheduleApi&#10;    val statisticsApi = remember { StatisticsApi(AuthApi.supabase) }&#10;    val scheduleApi = remember { ScheduleApi(AuthApi.supabase) }&#10;&#10;    // Function to load all data&#10;    suspend fun loadData() {&#10;        user?.user_id?.let { userId -&gt;&#10;            try {&#10;                // Fetch overall statistics&#10;                val statsResult = statisticsApi.getUserStatistics(userId)&#10;                statsResult.fold(&#10;                    onSuccess = { statistics -&gt;&#10;                        attendanceStatistics = AttendanceStatistics.fromOverallStatistic(statistics)&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Statistics loaded: $attendanceStatistics&quot;)&#10;                    },&#10;                    onFailure = { error -&gt;&#10;                        statisticsError = error.message ?: &quot;Failed to load statistics&quot;&#10;                        Log.e(&quot;HomeScreen&quot;, &quot;Error loading statistics&quot;, error)&#10;                    }&#10;                )&#10;&#10;                // Fetch weekly status&#10;                val weeklyResult = statisticsApi.getWeeklyStatus(userId)&#10;                weeklyResult.fold(&#10;                    onSuccess = { weekly -&gt;&#10;                        weeklyStatus = weekly&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Weekly status loaded: $weeklyStatus&quot;)&#10;                    },&#10;                    onFailure = { error -&gt;&#10;                        Log.e(&quot;HomeScreen&quot;, &quot;Error loading weekly status&quot;, error)&#10;                    }&#10;                )&#10;&#10;                // Fetch today's schedules&#10;                val todayResult = scheduleApi.getTodaySchedules(userId)&#10;                todayResult.fold(&#10;                    onSuccess = { schedules -&gt;&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Today schedules loaded: ${schedules.size} items&quot;)&#10;                        currentSchedule = determineCurrentSchedule(schedules)&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Current schedule: $currentSchedule&quot;)&#10;                    },&#10;                    onFailure = { error -&gt;&#10;                        Log.e(&quot;HomeScreen&quot;, &quot;Error loading today schedules&quot;, error)&#10;                    }&#10;                )&#10;            } catch (e: Exception) {&#10;                statisticsError = e.message ?: &quot;Unknown error occurred&quot;&#10;                Log.e(&quot;HomeScreen&quot;, &quot;Exception loading statistics&quot;, e)&#10;            }&#10;        }&#10;    }&#10;&#10;    // Fetch statistics saat pertama kali load&#10;    LaunchedEffect(user?.user_id) {&#10;        isLoadingStatistics = true&#10;        isLoadingWeekly = true&#10;        isLoadingSchedule = true&#10;        statisticsError = null&#10;&#10;        loadData()&#10;&#10;        isLoadingStatistics = false&#10;        isLoadingWeekly = false&#10;        isLoadingSchedule = false&#10;    }&#10;&#10;    // Get current date&#10;    val currentDate = remember { LocalDate.now() }&#10;    val dayOfMonth = currentDate.dayOfMonth&#10;    val dayOfWeek = currentDate.dayOfWeek&#10;    val month = currentDate.format(DateTimeFormatter.ofPattern(&quot;MMMM&quot;, Locale.ENGLISH))&#10;    val year = currentDate.year&#10;    val dayName = dayOfWeek.getDisplayName(java.time.format.TextStyle.FULL, Locale.ENGLISH)&#10;&#10;    PullToRefreshBox(&#10;        isRefreshing = isRefreshing,&#10;        onRefresh = {&#10;            coroutineScope.launch {&#10;                isRefreshing = true&#10;                loadData()&#10;                isRefreshing = false&#10;            }&#10;        },&#10;        modifier = Modifier.fillMaxSize()&#10;    ) {&#10;        Box(&#10;            modifier = Modifier.fillMaxSize()&#10;        ) {&#10;            Column(&#10;                modifier = Modifier.fillMaxSize()&#10;            ) {&#10;                // Background split - dark gray top, white bottom&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .weight(0.4f)&#10;                        .background(color = darkGray)&#10;                )&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .weight(0.6f)&#10;                        .background(color = Color.White)&#10;                )&#10;            }&#10;&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .verticalScroll(rememberScrollState())&#10;            ) {&#10;                // Header section&#10;                Row(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 25.dp, vertical = 20.dp),&#10;                    horizontalArrangement = Arrangement.SpaceBetween,&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    Column {&#10;                        Text(&#10;                            text = &quot;Hello, ${user?.full_name?.split(&quot; &quot;)?.firstOrNull() ?: &quot;User&quot;}!&quot;,&#10;                            fontSize = 28.sp,&#10;                            fontWeight = FontWeight.Bold,&#10;                            color = Color.White&#10;                        )&#10;                        Text(&#10;                            text = &quot;${user?.nim ?: &quot;Unknown&quot;}/Semester Ganjil&quot;,&#10;                            fontSize = 14.sp,&#10;                            color = Color.White.copy(alpha = 0.8f)&#10;                        )&#10;                    }&#10;&#10;                    IconButton(onClick = {&#10;                        coroutineScope.launch {&#10;                            sessionManager.clearSession()&#10;                            onLogout()&#10;                        }&#10;                    }) {&#10;                        Icon(&#10;                            imageVector = Icons.AutoMirrored.Rounded.ExitToApp,&#10;                            contentDescription = &quot;Logout&quot;,&#10;                            tint = Color.White,&#10;                            modifier = Modifier.size(40.dp)&#10;                        )&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(16.dp))&#10;&#10;                // Cards section with proper padding&#10;                Column(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 25.dp)&#10;                ) {&#10;                // Take attendance card - dynamic based on schedule&#10;                if (isLoadingSchedule) {&#10;                    // Loading state&#10;                    Card(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        shape = RoundedCornerShape(10.dp),&#10;                        colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                        elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                    ) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .fillMaxWidth()&#10;                                .padding(16.dp),&#10;                            contentAlignment = Alignment.Center&#10;                        ) {&#10;                            CircularProgressIndicator(&#10;                                color = darkGray,&#10;                                modifier = Modifier.size(24.dp)&#10;                            )&#10;                        }&#10;                    }&#10;                } else {&#10;                    // Show current or upcoming schedule&#10;                    currentSchedule?.let { schedule -&gt;&#10;                        Card(&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            shape = RoundedCornerShape(10.dp),&#10;                            colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                        ) {&#10;                            Row(&#10;                                verticalAlignment = Alignment.CenterVertically,&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .padding(horizontal = 12.dp, vertical = 8.dp)&#10;                            ) {&#10;                                Icon(&#10;                                    imageVector = Icons.Outlined.CalendarToday,&#10;                                    contentDescription = &quot;Calendar&quot;,&#10;                                    tint = Color.Black,&#10;                                    modifier = Modifier.size(20.dp)&#10;                                )&#10;                                Spacer(modifier = Modifier.width(8.dp))&#10;                                Column(&#10;                                    modifier = Modifier.weight(1f)&#10;                                ) {&#10;                                    Text(&#10;                                        text = schedule.courseName.uppercase(),&#10;                                        fontSize = 14.sp,&#10;                                        color = Color.Black,&#10;                                        fontWeight = FontWeight.Medium,&#10;                                        maxLines = 2&#10;                                    )&#10;                                    Text(&#10;                                        text = schedule.time,&#10;                                        fontSize = 12.sp,&#10;                                        color = Color.Gray,&#10;                                        modifier = Modifier.padding(top = 2.dp)&#10;                                    )&#10;                                }&#10;                                Spacer(modifier = Modifier.width(8.dp))&#10;                                if (schedule.isActive) {&#10;                                    // Show Submit button for active class&#10;                                    Button(&#10;                                        onClick = {&#10;                                            // Navigasi ke SubmissionScreen dengan parameter jadwal aktif&#10;                                            navController.navigate(&quot;submission_screen/${schedule.scheduleId}/${schedule.courseId}&quot;)&#10;                                        },&#10;                                        colors = ButtonDefaults.buttonColors(containerColor = redColor),&#10;                                        shape = RoundedCornerShape(8.dp),&#10;                                        modifier = Modifier.height(32.dp)&#10;                                    ) {&#10;                                        Text(&quot;Submit&quot;, fontSize = 14.sp, color = Color.White)&#10;                                    }&#10;                                } else {&#10;                                    // Show &quot;Not Yet&quot; indicator for upcoming class&#10;                                    Surface(&#10;                                        color = Color(0xFFE0E0E0),&#10;                                        shape = RoundedCornerShape(8.dp),&#10;                                        modifier = Modifier.height(32.dp)&#10;                                    ) {&#10;                                        Box(&#10;                                            modifier = Modifier.padding(horizontal = 12.dp),&#10;                                            contentAlignment = Alignment.Center&#10;                                        ) {&#10;                                            Text(&#10;                                                text = &quot;Not Yet&quot;,&#10;                                                fontSize = 14.sp,&#10;                                                color = Color.Gray,&#10;                                                fontWeight = FontWeight.Medium&#10;                                            )&#10;                                        }&#10;                                    }&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                // Date card&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .clickable { onDateClick() },&#10;                    shape = RoundedCornerShape(10.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier.padding(20.dp)&#10;                    ) {&#10;                        Row(&#10;                            verticalAlignment = Alignment.CenterVertically&#10;                        ) {&#10;                            Text(&#10;                                text = dayOfMonth.toString(),&#10;                                fontSize = 70.sp,&#10;                                fontWeight = FontWeight.Bold,&#10;                                color = Color.Black&#10;                            )&#10;                            Spacer(modifier = Modifier.width(16.dp))&#10;                            Column {&#10;                                Text(&#10;                                    text = dayName,&#10;                                    fontSize = 20.sp,&#10;                                    fontWeight = FontWeight.Medium,&#10;                                    color = Color.Black&#10;                                )&#10;                                Text(&#10;                                    text = &quot;$month $year&quot;,&#10;                                    fontSize = 14.sp,&#10;                                    color = Color.Gray&#10;                                )&#10;                            }&#10;                        }&#10;&#10;                        Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                        Text(&#10;                            text = &quot;This week status&quot;,&#10;                            fontSize = 14.sp,&#10;                            color = Color.Gray,&#10;                            modifier = Modifier.padding(bottom = 12.dp)&#10;                        )&#10;&#10;                        if (isLoadingWeekly) {&#10;                            // Loading state for weekly status&#10;                            Box(&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(50.dp),&#10;                                contentAlignment = Alignment.Center&#10;                            ) {&#10;                                CircularProgressIndicator(&#10;                                    color = darkGray,&#10;                                    modifier = Modifier.size(24.dp)&#10;                                )&#10;                            }&#10;                        } else {&#10;                            // Display weekly status from database&#10;                            Row(&#10;                                modifier = Modifier.fillMaxWidth(),&#10;                                horizontalArrangement = Arrangement.SpaceEvenly&#10;                            ) {&#10;                                WeekDayIndicator(&#10;                                    day = &quot;M&quot;,&#10;                                    status = weeklyStatus[&quot;monday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;T&quot;,&#10;                                    status = weeklyStatus[&quot;tuesday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;W&quot;,&#10;                                    status = weeklyStatus[&quot;wednesday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;Th&quot;,&#10;                                    status = weeklyStatus[&quot;thursday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;F&quot;,&#10;                                    status = weeklyStatus[&quot;friday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                // Statistics Card&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    shape = RoundedCornerShape(10.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(20.dp)&#10;                    ) {&#10;                        Text(&#10;                            text = &quot;This Semester&quot;,&#10;                            fontSize = 16.sp,&#10;                            fontWeight = FontWeight.Bold,&#10;                            color = Color.Black,&#10;                            modifier = Modifier.padding(bottom = 16.dp)&#10;                        )&#10;&#10;                        if (isLoadingStatistics) {&#10;                            // Loading state&#10;                            Box(&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(100.dp),&#10;                                contentAlignment = Alignment.Center&#10;                            ) {&#10;                                CircularProgressIndicator(&#10;                                    color = darkGray,&#10;                                    modifier = Modifier.size(40.dp)&#10;                                )&#10;                            }&#10;                        } else if (statisticsError != null) {&#10;                            // Error state&#10;                            Box(&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(100.dp),&#10;                                contentAlignment = Alignment.Center&#10;                            ) {&#10;                                Text(&#10;                                    text = &quot;Failed to load statistics&quot;,&#10;                                    color = Color.Red,&#10;                                    fontSize = 14.sp&#10;                                )&#10;                            }&#10;                        } else {&#10;                            // Donut charts - Scrollable horizontal dengan 5 charts&#10;                            LazyRow(&#10;                                modifier = Modifier.fillMaxWidth(),&#10;                                horizontalArrangement = Arrangement.spacedBy(20.dp),&#10;                                contentPadding = PaddingValues(horizontal = 8.dp)&#10;                            ) {&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.present,&#10;                                        percentage = attendanceStatistics.presentPercentage,&#10;                                        label = &quot;Present&quot;,&#10;                                        color = Color(0xFF4CAF50)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.late,&#10;                                        percentage = attendanceStatistics.latePercentage,&#10;                                        label = &quot;Late&quot;,&#10;                                        color = Color(0xFFFF9800)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.excused,&#10;                                        percentage = attendanceStatistics.excusedPercentage,&#10;                                        label = &quot;Excused&quot;,&#10;                                        color = Color(0xFF2196F3)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.sick,&#10;                                        percentage = attendanceStatistics.sickPercentage,&#10;                                        label = &quot;Sick&quot;,&#10;                                        color = Color(0xFFFFC107)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.absent,&#10;                                        percentage = attendanceStatistics.absentPercentage,&#10;                                        label = &quot;Absent&quot;,&#10;                                        color = Color(0xFF9E9E9E)&#10;                                    )&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                // Request Permission card&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .clickable { onRequestPermission() },&#10;                    shape = RoundedCornerShape(10.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(24.dp),&#10;                        horizontalAlignment = Alignment.CenterHorizontally&#10;                    ) {&#10;                        Icon(&#10;                            imageVector = Icons.Outlined.Description,&#10;                            contentDescription = &quot;Request Permission&quot;,&#10;                            tint = Color.Black,&#10;                            modifier = Modifier.size(36.dp)&#10;                        )&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;                        Text(&#10;                            text = &quot;Ask Permission&quot;,&#10;                            fontSize = 14.sp,&#10;                            color = Color.Black&#10;                        )&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;            }&#10;        }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun WeekDayIndicator(&#10;    day: String,&#10;    status: String?,&#10;    darkGray: Color,&#10;    redColor: Color&#10;) {&#10;    // Determine color based on attendance status&#10;    val color = when (status) {&#10;        &quot;present&quot; -&gt; Color(0xFF4CAF50)  // Green for present&#10;        &quot;late&quot; -&gt; Color(0xFFFF9800)      // Orange for late&#10;        &quot;absent&quot; -&gt; redColor              // Red for absent&#10;        &quot;excused&quot; -&gt; Color(0xFF2196F3)   // Blue for excused&#10;        &quot;sick&quot; -&gt; Color(0xFFFFC107)      // Yellow for sick&#10;        null -&gt; Color.LightGray           // Light gray for no data&#10;        else -&gt; Color.LightGray&#10;    }&#10;&#10;    val attended = status != null&#10;&#10;    Box(&#10;        modifier = Modifier&#10;            .size(40.dp)&#10;            .clip(CircleShape)&#10;            .background(if (attended) color else Color.White)&#10;            .border(2.dp, color, CircleShape),&#10;        contentAlignment = Alignment.Center&#10;    ) {&#10;        Text(&#10;            text = day,&#10;            color = if (attended) Color.White else color,&#10;            fontWeight = FontWeight.Bold,&#10;            fontSize = 12.sp&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;fun IndividualDonutChart(&#10;    value: Int,&#10;    percentage: Float,&#10;    label: String,&#10;    color: Color&#10;) {&#10;    Column(&#10;        horizontalAlignment = Alignment.CenterHorizontally,&#10;        verticalArrangement = Arrangement.Center&#10;    ) {&#10;        Box(&#10;            modifier = Modifier.size(60.dp),&#10;            contentAlignment = Alignment.Center&#10;        ) {&#10;            Canvas(modifier = Modifier.fillMaxSize()) {&#10;                val strokeWidth = 8.dp.toPx()&#10;                // Background circle&#10;                drawCircle(&#10;                    color = Color.LightGray.copy(alpha = 0.3f),&#10;                    style = Stroke(width = strokeWidth)&#10;                )&#10;                // Foreground arc&#10;                drawArc(&#10;                    color = color,&#10;                    startAngle = -90f,&#10;                    sweepAngle = percentage * 360 / 100, // Convert percentage to angle&#10;                    useCenter = false,&#10;                    style = Stroke(width = strokeWidth, cap = StrokeCap.Round)&#10;                )&#10;            }&#10;            Text(&#10;                text = value.toString(),&#10;                fontSize = 16.sp,&#10;                fontWeight = FontWeight.Bold,&#10;                color = Color.Black&#10;            )&#10;        }&#10;        Spacer(modifier = Modifier.height(4.dp))&#10;        Text(&#10;            text = label,&#10;            fontSize = 12.sp,&#10;            color = Color.Gray&#10;        )&#10;    }&#10;}&#10;&#10;@Preview(showBackground = true)&#10;@Composable&#10;fun HomeScreenPreview() {&#10;    SmartAttendanceTheme {&#10;        HomeScreen(user = AuthApi.User(full_name = &quot;Teo&quot;, email = &quot;&quot;, password_hash = &quot;&quot;), sessionManager = SessionManager(LocalContext.current), navController = rememberNavController())&#10;    }&#10;}&#10;&#10;// Data class for current schedule info&#10;data class CurrentScheduleInfo(&#10;    val courseName: String,&#10;    val time: String,&#10;    val isActive: Boolean,  // true if class is currently in session (within 15 min window)&#10;    val scheduleId: Int,    // id jadwal&#10;    val courseId: Int       // id course&#10;)&#10;&#10;// Local data class to match ScheduleApi.ScheduleItem structure&#10;private data class ScheduleItemData(&#10;    val title: String,&#10;    val time: String&#10;)&#10;&#10;// Helper function to determine current or next schedule&#10;private fun determineCurrentSchedule(schedules: List&lt;Any&gt;): CurrentScheduleInfo? {&#10;    if (schedules.isEmpty()) return null&#10;&#10;    val now = LocalTime.now()&#10;    val formatter = DateTimeFormatter.ofPattern(&quot;HH:mm:ss&quot;)&#10;&#10;    // Find if there's a class currently active (within 15 minutes of start time)&#10;    for (schedule in schedules) {&#10;        try {&#10;            // Access properties using reflection&#10;            val titleField = schedule::class.java.getDeclaredField(&quot;title&quot;)&#10;            val timeField = schedule::class.java.getDeclaredField(&quot;time&quot;)&#10;            val scheduleIdField = schedule::class.java.getDeclaredField(&quot;scheduleId&quot;)&#10;            val courseIdField = schedule::class.java.getDeclaredField(&quot;courseId&quot;)&#10;            titleField.isAccessible = true&#10;            timeField.isAccessible = true&#10;            scheduleIdField.isAccessible = true&#10;            courseIdField.isAccessible = true&#10;&#10;            val title = titleField.get(schedule) as String&#10;            val time = timeField.get(schedule) as String&#10;            val scheduleId = (scheduleIdField.get(schedule) as Number).toInt()&#10;            val courseId = (courseIdField.get(schedule) as Number).toInt()&#10;&#10;            // Extract course name from title (format: &quot;Course Name - CODE - ROOM&quot;)&#10;            val courseName = title.split(&quot; - &quot;).getOrNull(0) ?: title&#10;            val timeRange = time.split(&quot; - &quot;)&#10;            if (timeRange.size != 2) continue&#10;&#10;            val startTimeStr = convertTo24Hour(timeRange[0].trim())&#10;            val endTimeStr = convertTo24Hour(timeRange[1].trim())&#10;&#10;            val startTime = LocalTime.parse(startTimeStr, formatter)&#10;            val endTime = LocalTime.parse(endTimeStr, formatter)&#10;&#10;            // Check if class is in progress or within 15 minutes before start&#10;            val fifteenMinutesBefore = startTime.minusMinutes(15)&#10;&#10;            if (now.isAfter(fifteenMinutesBefore) &amp;&amp; now.isBefore(endTime)) {&#10;                // Class is active or about to start&#10;                return CurrentScheduleInfo(&#10;                    courseName = courseName,&#10;                    time = time,&#10;                    isActive = true,&#10;                    scheduleId = scheduleId,&#10;                    courseId = courseId&#10;                )&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(&quot;HomeScreen&quot;, &quot;Error parsing schedule&quot;, e)&#10;        }&#10;    }&#10;&#10;    // No active class, find the next upcoming class&#10;    for (schedule in schedules) {&#10;        try {&#10;            val titleField = schedule::class.java.getDeclaredField(&quot;title&quot;)&#10;            val timeField = schedule::class.java.getDeclaredField(&quot;time&quot;)&#10;            val scheduleIdField = schedule::class.java.getDeclaredField(&quot;scheduleId&quot;)&#10;            val courseIdField = schedule::class.java.getDeclaredField(&quot;courseId&quot;)&#10;            titleField.isAccessible = true&#10;            timeField.isAccessible = true&#10;            scheduleIdField.isAccessible = true&#10;            courseIdField.isAccessible = true&#10;&#10;            val title = titleField.get(schedule) as String&#10;            val time = timeField.get(schedule) as String&#10;            val scheduleId = (scheduleIdField.get(schedule) as Number).toInt()&#10;            val courseId = (courseIdField.get(schedule) as Number).toInt()&#10;&#10;            val courseName = title.split(&quot; - &quot;).getOrNull(0) ?: title&#10;            val timeRange = time.split(&quot; - &quot;)&#10;            if (timeRange.size != 2) continue&#10;&#10;            val startTimeStr = convertTo24Hour(timeRange[0].trim())&#10;            val startTime = LocalTime.parse(startTimeStr, formatter)&#10;&#10;            if (now.isBefore(startTime)) {&#10;                // This is the next class&#10;                return CurrentScheduleInfo(&#10;                    courseName = courseName,&#10;                    time = time,&#10;                    isActive = false,&#10;                    scheduleId = scheduleId,&#10;                    courseId = courseId&#10;                )&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(&quot;HomeScreen&quot;, &quot;Error parsing schedule&quot;, e)&#10;        }&#10;    }&#10;&#10;    // All classes have passed for today&#10;    return null&#10;}&#10;&#10;// Helper function to convert 12-hour format to 24-hour format&#10;private fun convertTo24Hour(time12h: String): String {&#10;    return try {&#10;        val parts = time12h.split(&quot; &quot;)&#10;        if (parts.size != 2) return &quot;00:00:00&quot;&#10;&#10;        val timePart = parts[0]&#10;        val period = parts[1].uppercase()&#10;&#10;        val timeParts = timePart.split(&quot;:&quot;)&#10;        if (timeParts.size != 2) return &quot;00:00:00&quot;&#10;&#10;        var hour = timeParts[0].toInt()&#10;        val minute = timeParts[1]&#10;&#10;        // Convert to 24-hour format&#10;        if (period == &quot;PM&quot; &amp;&amp; hour != 12) {&#10;            hour += 12&#10;        } else if (period == &quot;AM&quot; &amp;&amp; hour == 12) {&#10;            hour = 0&#10;        }&#10;&#10;        String.format(&quot;%02d:%s:00&quot;, hour, minute)&#10;    } catch (e: Exception) {&#10;        Log.e(&quot;HomeScreen&quot;, &quot;Error converting time: $time12h&quot;, e)&#10;        &quot;00:00:00&quot;&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.smartattendance.ui.screens&#10;&#10;import androidx.compose.foundation.Canvas&#10;import androidx.compose.foundation.background&#10;import androidx.compose.foundation.border&#10;import androidx.compose.foundation.clickable&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.foundation.lazy.LazyRow&#10;import androidx.compose.foundation.lazy.itemsIndexed&#10;import androidx.compose.foundation.lazy.rememberLazyListState&#10;import androidx.compose.foundation.rememberScrollState&#10;import androidx.compose.foundation.shape.CircleShape&#10;import androidx.compose.foundation.shape.RoundedCornerShape&#10;import androidx.compose.foundation.verticalScroll&#10;import androidx.compose.material.icons.Icons&#10;import androidx.compose.material.icons.automirrored.rounded.ExitToApp&#10;import androidx.compose.material.icons.outlined.CalendarToday&#10;import androidx.compose.material.icons.outlined.Description&#10;import androidx.compose.material3.*&#10;import androidx.compose.material3.pulltorefresh.PullToRefreshBox&#10;import androidx.compose.material3.pulltorefresh.rememberPullToRefreshState&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.draw.clip&#10;import androidx.compose.ui.graphics.Color&#10;import androidx.compose.ui.graphics.StrokeCap&#10;import androidx.compose.ui.graphics.drawscope.Stroke&#10;import androidx.compose.ui.graphics.graphicsLayer&#10;import androidx.compose.ui.text.font.FontWeight&#10;import androidx.compose.ui.tooling.preview.Preview&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.unit.sp&#10;import com.example.smartattendance.api.AuthApi&#10;import com.example.smartattendance.api.StatisticsApi&#10;import com.example.smartattendance.api.ScheduleApi&#10;import com.example.smartattendance.api.AttendanceApi&#10;import com.example.smartattendance.data.AttendanceStatistics&#10;import java.time.LocalTime&#10;import com.example.smartattendance.ui.theme.SmartAttendanceTheme&#10;import com.example.smartattendance.utils.SessionManager&#10;import java.time.LocalDate&#10;import java.time.format.DateTimeFormatter&#10;import java.util.Locale&#10;import kotlin.math.abs&#10;import kotlinx.coroutines.launch&#10;import androidx.compose.ui.platform.LocalContext&#10;import android.util.Log&#10;import androidx.core.view.WindowCompat&#10;import androidx.core.view.WindowInsetsControllerCompat&#10;import androidx.compose.ui.platform.LocalView&#10;import android.app.Activity&#10;import androidx.navigation.NavController&#10;import androidx.navigation.compose.rememberNavController&#10;&#10;@OptIn(ExperimentalMaterial3Api::class)&#10;@Composable&#10;fun HomeScreen(&#10;    user: AuthApi.User?,&#10;    sessionManager: SessionManager,&#10;    navController: NavController,&#10;    onLogout: () -&gt; Unit = {},&#10;    onDateClick: () -&gt; Unit = {},&#10;    onRequestPermission: () -&gt; Unit = {},&#10;    onBackClick: () -&gt; Unit = {}&#10;) {&#10;    val darkGray = Color(0xFF2C2D32)&#10;    val redColor = Color(0xFFE0697E)&#10;    val coroutineScope = rememberCoroutineScope()&#10;&#10;    // Set status bar color to match header&#10;    val view = LocalView.current&#10;    val window = (view.context as? Activity)?.window&#10;    window?.let {&#10;        WindowCompat.setDecorFitsSystemWindows(it, false)&#10;        val controller = WindowInsetsControllerCompat(it, view)&#10;        controller.isAppearanceLightStatusBars = true // Light icons on dark background&#10;        it.statusBarColor = 0xFF2C2D32.toInt()&#10;    }&#10;&#10;    // State untuk statistik presensi&#10;    var attendanceStatistics by remember { mutableStateOf(AttendanceStatistics.empty()) }&#10;    var isLoadingStatistics by remember { mutableStateOf(false) }&#10;    var statisticsError by remember { mutableStateOf&lt;String?&gt;(null) }&#10;&#10;    // State untuk weekly status&#10;    var weeklyStatus by remember { mutableStateOf&lt;Map&lt;String, String?&gt;&gt;(emptyMap()) }&#10;    var isLoadingWeekly by remember { mutableStateOf(false) }&#10;&#10;    // State untuk current schedule&#10;    var currentSchedule by remember { mutableStateOf&lt;CurrentScheduleInfo?&gt;(null) }&#10;    var isLoadingSchedule by remember { mutableStateOf(false) }&#10;&#10;    // State untuk tracking jika attendance sudah verified&#10;    var isAttendanceVerified by remember { mutableStateOf(false) }&#10;&#10;    // State untuk pull-to-refresh&#10;    var isRefreshing by remember { mutableStateOf(false) }&#10;&#10;    // Initialize StatisticsApi and ScheduleApi&#10;    val statisticsApi = remember { StatisticsApi(AuthApi.supabase) }&#10;    val scheduleApi = remember { ScheduleApi(AuthApi.supabase) }&#10;    val attendanceApi = remember { AttendanceApi(AuthApi.supabase) }&#10;&#10;    // Function to load all data&#10;    suspend fun loadData() {&#10;        user?.user_id?.let { userId -&gt;&#10;            try {&#10;                // Fetch overall statistics&#10;                val statsResult = statisticsApi.getUserStatistics(userId)&#10;                statsResult.fold(&#10;                    onSuccess = { statistics -&gt;&#10;                        attendanceStatistics = AttendanceStatistics.fromOverallStatistic(statistics)&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Statistics loaded: $attendanceStatistics&quot;)&#10;                    },&#10;                    onFailure = { error -&gt;&#10;                        statisticsError = error.message ?: &quot;Failed to load statistics&quot;&#10;                        Log.e(&quot;HomeScreen&quot;, &quot;Error loading statistics&quot;, error)&#10;                    }&#10;                )&#10;&#10;                // Fetch weekly status&#10;                val weeklyResult = statisticsApi.getWeeklyStatus(userId)&#10;                weeklyResult.fold(&#10;                    onSuccess = { weekly -&gt;&#10;                        weeklyStatus = weekly&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Weekly status loaded: $weeklyStatus&quot;)&#10;                    },&#10;                    onFailure = { error -&gt;&#10;                        Log.e(&quot;HomeScreen&quot;, &quot;Error loading weekly status&quot;, error)&#10;                    }&#10;                )&#10;&#10;                // Fetch today's schedules&#10;                val todayResult = scheduleApi.getTodaySchedules(userId)&#10;                todayResult.fold(&#10;                    onSuccess = { schedules -&gt;&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Today schedules loaded: ${schedules.size} items&quot;)&#10;                        currentSchedule = determineCurrentSchedule(schedules)&#10;                        Log.d(&quot;HomeScreen&quot;, &quot;Current schedule: $currentSchedule&quot;)&#10;&#10;                        // Check if attendance is already verified for current schedule&#10;                        currentSchedule?.let { schedule -&gt;&#10;                            val attendanceResult = attendanceApi.getTodayAttendance(&#10;                                userId,&#10;                                schedule.scheduleId,&#10;                                schedule.courseId&#10;                            )&#10;                            attendanceResult.fold(&#10;                                onSuccess = { attendance -&gt;&#10;                                    isAttendanceVerified = attendance?.is_verified == true&#10;                                    Log.d(&quot;HomeScreen&quot;, &quot;Attendance verified status: $isAttendanceVerified&quot;)&#10;                                },&#10;                                onFailure = {&#10;                                    isAttendanceVerified = false&#10;                                }&#10;                            )&#10;                        } ?: run {&#10;                            isAttendanceVerified = false&#10;                        }&#10;                    },&#10;                    onFailure = { error -&gt;&#10;                        Log.e(&quot;HomeScreen&quot;, &quot;Error loading today schedules&quot;, error)&#10;                    }&#10;                )&#10;            } catch (e: Exception) {&#10;                statisticsError = e.message ?: &quot;Unknown error occurred&quot;&#10;                Log.e(&quot;HomeScreen&quot;, &quot;Exception loading statistics&quot;, e)&#10;            }&#10;        }&#10;    }&#10;&#10;    // Fetch statistics saat pertama kali load&#10;    LaunchedEffect(user?.user_id) {&#10;        isLoadingStatistics = true&#10;        isLoadingWeekly = true&#10;        isLoadingSchedule = true&#10;        statisticsError = null&#10;&#10;        loadData()&#10;&#10;        isLoadingStatistics = false&#10;        isLoadingWeekly = false&#10;        isLoadingSchedule = false&#10;    }&#10;&#10;    // Get current date&#10;    val currentDate = remember { LocalDate.now() }&#10;    val dayOfMonth = currentDate.dayOfMonth&#10;    val dayOfWeek = currentDate.dayOfWeek&#10;    val month = currentDate.format(DateTimeFormatter.ofPattern(&quot;MMMM&quot;, Locale.ENGLISH))&#10;    val year = currentDate.year&#10;    val dayName = dayOfWeek.getDisplayName(java.time.format.TextStyle.FULL, Locale.ENGLISH)&#10;&#10;    PullToRefreshBox(&#10;        isRefreshing = isRefreshing,&#10;        onRefresh = {&#10;            coroutineScope.launch {&#10;                isRefreshing = true&#10;                loadData()&#10;                isRefreshing = false&#10;            }&#10;        },&#10;        modifier = Modifier.fillMaxSize()&#10;    ) {&#10;        Box(&#10;            modifier = Modifier.fillMaxSize()&#10;        ) {&#10;            Column(&#10;                modifier = Modifier.fillMaxSize()&#10;            ) {&#10;                // Background split - dark gray top, white bottom&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .weight(0.4f)&#10;                        .background(color = darkGray)&#10;                )&#10;                Box(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .weight(0.6f)&#10;                        .background(color = Color.White)&#10;                )&#10;            }&#10;&#10;            Column(&#10;                modifier = Modifier&#10;                    .fillMaxSize()&#10;                    .verticalScroll(rememberScrollState())&#10;            ) {&#10;                // Header section&#10;                Row(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 25.dp, vertical = 20.dp),&#10;                    horizontalArrangement = Arrangement.SpaceBetween,&#10;                    verticalAlignment = Alignment.CenterVertically&#10;                ) {&#10;                    Column {&#10;                        Text(&#10;                            text = &quot;Hello, ${user?.full_name?.split(&quot; &quot;)?.firstOrNull() ?: &quot;User&quot;}!&quot;,&#10;                            fontSize = 28.sp,&#10;                            fontWeight = FontWeight.Bold,&#10;                            color = Color.White&#10;                        )&#10;                        Text(&#10;                            text = &quot;${user?.nim ?: &quot;Unknown&quot;}/Semester Ganjil&quot;,&#10;                            fontSize = 14.sp,&#10;                            color = Color.White.copy(alpha = 0.8f)&#10;                        )&#10;                    }&#10;&#10;                    IconButton(onClick = {&#10;                        coroutineScope.launch {&#10;                            sessionManager.clearSession()&#10;                            onLogout()&#10;                        }&#10;                    }) {&#10;                        Icon(&#10;                            imageVector = Icons.AutoMirrored.Rounded.ExitToApp,&#10;                            contentDescription = &quot;Logout&quot;,&#10;                            tint = Color.White,&#10;                            modifier = Modifier.size(40.dp)&#10;                        )&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(16.dp))&#10;&#10;                // Cards section with proper padding&#10;                Column(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .padding(horizontal = 25.dp)&#10;                ) {&#10;                // Take attendance card - dynamic based on schedule&#10;                if (isLoadingSchedule) {&#10;                    // Loading state&#10;                    Card(&#10;                        modifier = Modifier.fillMaxWidth(),&#10;                        shape = RoundedCornerShape(10.dp),&#10;                        colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                        elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                    ) {&#10;                        Box(&#10;                            modifier = Modifier&#10;                                .fillMaxWidth()&#10;                                .padding(16.dp),&#10;                            contentAlignment = Alignment.Center&#10;                        ) {&#10;                            CircularProgressIndicator(&#10;                                color = darkGray,&#10;                                modifier = Modifier.size(24.dp)&#10;                            )&#10;                        }&#10;                    }&#10;                } else {&#10;                    // Show current or upcoming schedule&#10;                    currentSchedule?.let { schedule -&gt;&#10;                        Card(&#10;                            modifier = Modifier.fillMaxWidth(),&#10;                            shape = RoundedCornerShape(10.dp),&#10;                            colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                            elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                        ) {&#10;                            Row(&#10;                                verticalAlignment = Alignment.CenterVertically,&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .padding(horizontal = 12.dp, vertical = 8.dp)&#10;                            ) {&#10;                                Icon(&#10;                                    imageVector = Icons.Outlined.CalendarToday,&#10;                                    contentDescription = &quot;Calendar&quot;,&#10;                                    tint = Color.Black,&#10;                                    modifier = Modifier.size(20.dp)&#10;                                )&#10;                                Spacer(modifier = Modifier.width(8.dp))&#10;                                Column(&#10;                                    modifier = Modifier.weight(1f)&#10;                                ) {&#10;                                    Text(&#10;                                        text = schedule.courseName.uppercase(),&#10;                                        fontSize = 14.sp,&#10;                                        color = Color.Black,&#10;                                        fontWeight = FontWeight.Medium,&#10;                                        maxLines = 2&#10;                                    )&#10;                                    Text(&#10;                                        text = schedule.time,&#10;                                        fontSize = 12.sp,&#10;                                        color = Color.Gray,&#10;                                        modifier = Modifier.padding(top = 2.dp)&#10;                                    )&#10;                                }&#10;                                Spacer(modifier = Modifier.width(8.dp))&#10;                                if (schedule.isActive &amp;&amp; !isAttendanceVerified) {&#10;                                    // Show Submit button only if class is active AND attendance not yet verified&#10;                                    Button(&#10;                                        onClick = {&#10;                                            // Navigasi ke SubmissionScreen dengan parameter jadwal aktif&#10;                                            navController.navigate(&quot;submission_screen/${schedule.scheduleId}/${schedule.courseId}&quot;)&#10;                                        },&#10;                                        colors = ButtonDefaults.buttonColors(containerColor = redColor),&#10;                                        shape = RoundedCornerShape(8.dp),&#10;                                        modifier = Modifier.height(32.dp)&#10;                                    ) {&#10;                                        Text(&quot;Submit&quot;, fontSize = 14.sp, color = Color.White)&#10;                                    }&#10;                                } else if (schedule.isActive &amp;&amp; isAttendanceVerified) {&#10;                                    // Show &quot;Verified&quot; indicator if attendance is already verified&#10;                                    Surface(&#10;                                        color = Color(0xFF4CAF50),&#10;                                        shape = RoundedCornerShape(8.dp),&#10;                                        modifier = Modifier.height(32.dp)&#10;                                    ) {&#10;                                        Box(&#10;                                            modifier = Modifier.padding(horizontal = 12.dp),&#10;                                            contentAlignment = Alignment.Center&#10;                                        ) {&#10;                                            Text(&#10;                                                text = &quot;Verified&quot;,&#10;                                                fontSize = 14.sp,&#10;                                                color = Color.White,&#10;                                                fontWeight = FontWeight.Medium&#10;                                            )&#10;                                        }&#10;                                    }&#10;                                } else {&#10;                                    // Show &quot;Not Yet&quot; indicator for upcoming class&#10;                                    Surface(&#10;                                        color = Color(0xFFE0E0E0),&#10;                                        shape = RoundedCornerShape(8.dp),&#10;                                        modifier = Modifier.height(32.dp)&#10;                                    ) {&#10;                                        Box(&#10;                                            modifier = Modifier.padding(horizontal = 12.dp),&#10;                                            contentAlignment = Alignment.Center&#10;                                        ) {&#10;                                            Text(&#10;                                                text = &quot;Not Yet&quot;,&#10;                                                fontSize = 14.sp,&#10;                                                color = Color.Gray,&#10;                                                fontWeight = FontWeight.Medium&#10;                                            )&#10;                                        }&#10;                                    }&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                // Date card&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .clickable { onDateClick() },&#10;                    shape = RoundedCornerShape(10.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier.padding(20.dp)&#10;                    ) {&#10;                        Row(&#10;                            verticalAlignment = Alignment.CenterVertically&#10;                        ) {&#10;                            Text(&#10;                                text = dayOfMonth.toString(),&#10;                                fontSize = 70.sp,&#10;                                fontWeight = FontWeight.Bold,&#10;                                color = Color.Black&#10;                            )&#10;                            Spacer(modifier = Modifier.width(16.dp))&#10;                            Column {&#10;                                Text(&#10;                                    text = dayName,&#10;                                    fontSize = 20.sp,&#10;                                    fontWeight = FontWeight.Medium,&#10;                                    color = Color.Black&#10;                                )&#10;                                Text(&#10;                                    text = &quot;$month $year&quot;,&#10;                                    fontSize = 14.sp,&#10;                                    color = Color.Gray&#10;                                )&#10;                            }&#10;                        }&#10;&#10;                        Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                        Text(&#10;                            text = &quot;This week status&quot;,&#10;                            fontSize = 14.sp,&#10;                            color = Color.Gray,&#10;                            modifier = Modifier.padding(bottom = 12.dp)&#10;                        )&#10;&#10;                        if (isLoadingWeekly) {&#10;                            // Loading state for weekly status&#10;                            Box(&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(50.dp),&#10;                                contentAlignment = Alignment.Center&#10;                            ) {&#10;                                CircularProgressIndicator(&#10;                                    color = darkGray,&#10;                                    modifier = Modifier.size(24.dp)&#10;                                )&#10;                            }&#10;                        } else {&#10;                            // Display weekly status from database&#10;                            Row(&#10;                                modifier = Modifier.fillMaxWidth(),&#10;                                horizontalArrangement = Arrangement.SpaceEvenly&#10;                            ) {&#10;                                WeekDayIndicator(&#10;                                    day = &quot;M&quot;,&#10;                                    status = weeklyStatus[&quot;monday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;T&quot;,&#10;                                    status = weeklyStatus[&quot;tuesday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;W&quot;,&#10;                                    status = weeklyStatus[&quot;wednesday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;Th&quot;,&#10;                                    status = weeklyStatus[&quot;thursday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                                WeekDayIndicator(&#10;                                    day = &quot;F&quot;,&#10;                                    status = weeklyStatus[&quot;friday&quot;],&#10;                                    darkGray = darkGray,&#10;                                    redColor = redColor&#10;                                )&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                // Statistics Card&#10;                Card(&#10;                    modifier = Modifier.fillMaxWidth(),&#10;                    shape = RoundedCornerShape(10.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(20.dp)&#10;                    ) {&#10;                        Text(&#10;                            text = &quot;This Semester&quot;,&#10;                            fontSize = 16.sp,&#10;                            fontWeight = FontWeight.Bold,&#10;                            color = Color.Black,&#10;                            modifier = Modifier.padding(bottom = 16.dp)&#10;                        )&#10;&#10;                        if (isLoadingStatistics) {&#10;                            // Loading state&#10;                            Box(&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(100.dp),&#10;                                contentAlignment = Alignment.Center&#10;                            ) {&#10;                                CircularProgressIndicator(&#10;                                    color = darkGray,&#10;                                    modifier = Modifier.size(40.dp)&#10;                                )&#10;                            }&#10;                        } else if (statisticsError != null) {&#10;                            // Error state&#10;                            Box(&#10;                                modifier = Modifier&#10;                                    .fillMaxWidth()&#10;                                    .height(100.dp),&#10;                                contentAlignment = Alignment.Center&#10;                            ) {&#10;                                Text(&#10;                                    text = &quot;Failed to load statistics&quot;,&#10;                                    color = Color.Red,&#10;                                    fontSize = 14.sp&#10;                                )&#10;                            }&#10;                        } else {&#10;                            // Donut charts - Scrollable horizontal dengan 5 charts&#10;                            LazyRow(&#10;                                modifier = Modifier.fillMaxWidth(),&#10;                                horizontalArrangement = Arrangement.spacedBy(20.dp),&#10;                                contentPadding = PaddingValues(horizontal = 8.dp)&#10;                            ) {&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.present,&#10;                                        percentage = attendanceStatistics.presentPercentage,&#10;                                        label = &quot;Present&quot;,&#10;                                        color = Color(0xFF4CAF50)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.late,&#10;                                        percentage = attendanceStatistics.latePercentage,&#10;                                        label = &quot;Late&quot;,&#10;                                        color = Color(0xFFFF9800)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.excused,&#10;                                        percentage = attendanceStatistics.excusedPercentage,&#10;                                        label = &quot;Excused&quot;,&#10;                                        color = Color(0xFF2196F3)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.sick,&#10;                                        percentage = attendanceStatistics.sickPercentage,&#10;                                        label = &quot;Sick&quot;,&#10;                                        color = Color(0xFFFFC107)&#10;                                    )&#10;                                }&#10;                                item {&#10;                                    IndividualDonutChart(&#10;                                        value = attendanceStatistics.absent,&#10;                                        percentage = attendanceStatistics.absentPercentage,&#10;                                        label = &quot;Absent&quot;,&#10;                                        color = Color(0xFF9E9E9E)&#10;                                    )&#10;                                }&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;&#10;                // Request Permission card&#10;                Card(&#10;                    modifier = Modifier&#10;                        .fillMaxWidth()&#10;                        .clickable { onRequestPermission() },&#10;                    shape = RoundedCornerShape(10.dp),&#10;                    colors = CardDefaults.cardColors(containerColor = Color.White),&#10;                    elevation = CardDefaults.cardElevation(defaultElevation = 8.dp)&#10;                ) {&#10;                    Column(&#10;                        modifier = Modifier&#10;                            .fillMaxWidth()&#10;                            .padding(24.dp),&#10;                        horizontalAlignment = Alignment.CenterHorizontally&#10;                    ) {&#10;                        Icon(&#10;                            imageVector = Icons.Outlined.Description,&#10;                            contentDescription = &quot;Request Permission&quot;,&#10;                            tint = Color.Black,&#10;                            modifier = Modifier.size(36.dp)&#10;                        )&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;                        Text(&#10;                            text = &quot;Ask Permission&quot;,&#10;                            fontSize = 14.sp,&#10;                            color = Color.Black&#10;                        )&#10;                    }&#10;                }&#10;&#10;                Spacer(modifier = Modifier.height(20.dp))&#10;            }&#10;        }&#10;        }&#10;    }&#10;}&#10;&#10;@Composable&#10;fun WeekDayIndicator(&#10;    day: String,&#10;    status: String?,&#10;    darkGray: Color,&#10;    redColor: Color&#10;) {&#10;    // Determine color based on attendance status&#10;    val color = when (status) {&#10;        &quot;present&quot; -&gt; Color(0xFF4CAF50)  // Green for present&#10;        &quot;late&quot; -&gt; Color(0xFFFF9800)      // Orange for late&#10;        &quot;absent&quot; -&gt; redColor              // Red for absent&#10;        &quot;excused&quot; -&gt; Color(0xFF2196F3)   // Blue for excused&#10;        &quot;sick&quot; -&gt; Color(0xFFFFC107)      // Yellow for sick&#10;        null -&gt; Color.LightGray           // Light gray for no data&#10;        else -&gt; Color.LightGray&#10;    }&#10;&#10;    val attended = status != null&#10;&#10;    Box(&#10;        modifier = Modifier&#10;            .size(40.dp)&#10;            .clip(CircleShape)&#10;            .background(if (attended) color else Color.White)&#10;            .border(2.dp, color, CircleShape),&#10;        contentAlignment = Alignment.Center&#10;    ) {&#10;        Text(&#10;            text = day,&#10;            color = if (attended) Color.White else color,&#10;            fontWeight = FontWeight.Bold,&#10;            fontSize = 12.sp&#10;        )&#10;    }&#10;}&#10;&#10;@Composable&#10;fun IndividualDonutChart(&#10;    value: Int,&#10;    percentage: Float,&#10;    label: String,&#10;    color: Color&#10;) {&#10;    Column(&#10;        horizontalAlignment = Alignment.CenterHorizontally,&#10;        verticalArrangement = Arrangement.Center&#10;    ) {&#10;        Box(&#10;            modifier = Modifier.size(60.dp),&#10;            contentAlignment = Alignment.Center&#10;        ) {&#10;            Canvas(modifier = Modifier.fillMaxSize()) {&#10;                val strokeWidth = 8.dp.toPx()&#10;                // Background circle&#10;                drawCircle(&#10;                    color = Color.LightGray.copy(alpha = 0.3f),&#10;                    style = Stroke(width = strokeWidth)&#10;                )&#10;                // Foreground arc&#10;                drawArc(&#10;                    color = color,&#10;                    startAngle = -90f,&#10;                    sweepAngle = percentage * 360 / 100, // Convert percentage to angle&#10;                    useCenter = false,&#10;                    style = Stroke(width = strokeWidth, cap = StrokeCap.Round)&#10;                )&#10;            }&#10;            Text(&#10;                text = value.toString(),&#10;                fontSize = 16.sp,&#10;                fontWeight = FontWeight.Bold,&#10;                color = Color.Black&#10;            )&#10;        }&#10;        Spacer(modifier = Modifier.height(4.dp))&#10;        Text(&#10;            text = label,&#10;            fontSize = 12.sp,&#10;            color = Color.Gray&#10;        )&#10;    }&#10;}&#10;&#10;@Preview(showBackground = true)&#10;@Composable&#10;fun HomeScreenPreview() {&#10;    SmartAttendanceTheme {&#10;        HomeScreen(user = AuthApi.User(full_name = &quot;Teo&quot;, email = &quot;&quot;, password_hash = &quot;&quot;), sessionManager = SessionManager(LocalContext.current), navController = rememberNavController())&#10;    }&#10;}&#10;&#10;// Data class for current schedule info&#10;data class CurrentScheduleInfo(&#10;    val courseName: String,&#10;    val time: String,&#10;    val isActive: Boolean,  // true if class is currently in session (within 15 min window)&#10;    val scheduleId: Int,    // id jadwal&#10;    val courseId: Int       // id course&#10;)&#10;&#10;// Local data class to match ScheduleApi.ScheduleItem structure&#10;private data class ScheduleItemData(&#10;    val title: String,&#10;    val time: String&#10;)&#10;&#10;// Helper function to determine current or next schedule&#10;private fun determineCurrentSchedule(schedules: List&lt;Any&gt;): CurrentScheduleInfo? {&#10;    if (schedules.isEmpty()) return null&#10;&#10;    val now = LocalTime.now()&#10;    val formatter = DateTimeFormatter.ofPattern(&quot;HH:mm:ss&quot;)&#10;&#10;    // Find if there's a class currently active (within 15 minutes of start time)&#10;    for (schedule in schedules) {&#10;        try {&#10;            // Access properties using reflection&#10;            val titleField = schedule::class.java.getDeclaredField(&quot;title&quot;)&#10;            val timeField = schedule::class.java.getDeclaredField(&quot;time&quot;)&#10;            val scheduleIdField = schedule::class.java.getDeclaredField(&quot;scheduleId&quot;)&#10;            val courseIdField = schedule::class.java.getDeclaredField(&quot;courseId&quot;)&#10;            titleField.isAccessible = true&#10;            timeField.isAccessible = true&#10;            scheduleIdField.isAccessible = true&#10;            courseIdField.isAccessible = true&#10;&#10;            val title = titleField.get(schedule) as String&#10;            val time = timeField.get(schedule) as String&#10;            val scheduleId = (scheduleIdField.get(schedule) as Number).toInt()&#10;            val courseId = (courseIdField.get(schedule) as Number).toInt()&#10;&#10;            // Extract course name from title (format: &quot;Course Name - CODE - ROOM&quot;)&#10;            val courseName = title.split(&quot; - &quot;).getOrNull(0) ?: title&#10;            val timeRange = time.split(&quot; - &quot;)&#10;            if (timeRange.size != 2) continue&#10;&#10;            val startTimeStr = convertTo24Hour(timeRange[0].trim())&#10;            val endTimeStr = convertTo24Hour(timeRange[1].trim())&#10;&#10;            val startTime = LocalTime.parse(startTimeStr, formatter)&#10;            val endTime = LocalTime.parse(endTimeStr, formatter)&#10;&#10;            // Check if class is in progress or within 15 minutes before start&#10;            val fifteenMinutesBefore = startTime.minusMinutes(15)&#10;&#10;            if (now.isAfter(fifteenMinutesBefore) &amp;&amp; now.isBefore(endTime)) {&#10;                // Class is active or about to start&#10;                return CurrentScheduleInfo(&#10;                    courseName = courseName,&#10;                    time = time,&#10;                    isActive = true,&#10;                    scheduleId = scheduleId,&#10;                    courseId = courseId&#10;                )&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(&quot;HomeScreen&quot;, &quot;Error parsing schedule&quot;, e)&#10;        }&#10;    }&#10;&#10;    // No active class, find the next upcoming class&#10;    for (schedule in schedules) {&#10;        try {&#10;            val titleField = schedule::class.java.getDeclaredField(&quot;title&quot;)&#10;            val timeField = schedule::class.java.getDeclaredField(&quot;time&quot;)&#10;            val scheduleIdField = schedule::class.java.getDeclaredField(&quot;scheduleId&quot;)&#10;            val courseIdField = schedule::class.java.getDeclaredField(&quot;courseId&quot;)&#10;            titleField.isAccessible = true&#10;            timeField.isAccessible = true&#10;            scheduleIdField.isAccessible = true&#10;            courseIdField.isAccessible = true&#10;&#10;            val title = titleField.get(schedule) as String&#10;            val time = timeField.get(schedule) as String&#10;            val scheduleId = (scheduleIdField.get(schedule) as Number).toInt()&#10;            val courseId = (courseIdField.get(schedule) as Number).toInt()&#10;&#10;            val courseName = title.split(&quot; - &quot;).getOrNull(0) ?: title&#10;            val timeRange = time.split(&quot; - &quot;)&#10;            if (timeRange.size != 2) continue&#10;&#10;            val startTimeStr = convertTo24Hour(timeRange[0].trim())&#10;            val startTime = LocalTime.parse(startTimeStr, formatter)&#10;&#10;            if (now.isBefore(startTime)) {&#10;                // This is the next class&#10;                return CurrentScheduleInfo(&#10;                    courseName = courseName,&#10;                    time = time,&#10;                    isActive = false,&#10;                    scheduleId = scheduleId,&#10;                    courseId = courseId&#10;                )&#10;            }&#10;        } catch (e: Exception) {&#10;            Log.e(&quot;HomeScreen&quot;, &quot;Error parsing schedule&quot;, e)&#10;        }&#10;    }&#10;&#10;    // All classes have passed for today&#10;    return null&#10;}&#10;&#10;// Helper function to convert 12-hour format to 24-hour format&#10;private fun convertTo24Hour(time12h: String): String {&#10;    return try {&#10;        val parts = time12h.split(&quot; &quot;)&#10;        if (parts.size != 2) return &quot;00:00:00&quot;&#10;&#10;        val timePart = parts[0]&#10;        val period = parts[1].uppercase()&#10;&#10;        val timeParts = timePart.split(&quot;:&quot;)&#10;        if (timeParts.size != 2) return &quot;00:00:00&quot;&#10;&#10;        var hour = timeParts[0].toInt()&#10;        val minute = timeParts[1]&#10;&#10;        // Convert to 24-hour format&#10;        if (period == &quot;PM&quot; &amp;&amp; hour != 12) {&#10;            hour += 12&#10;        } else if (period == &quot;AM&quot; &amp;&amp; hour == 12) {&#10;            hour = 0&#10;        }&#10;&#10;        String.format(&quot;%02d:%s:00&quot;, hour, minute)&#10;    } catch (e: Exception) {&#10;        Log.e(&quot;HomeScreen&quot;, &quot;Error converting time: $time12h&quot;, e)&#10;        &quot;00:00:00&quot;&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database_functions.sql">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database_functions.sql" />
              <option name="updatedContent" value="-- ==============================&#10;-- STORED PROCEDURES FOR STATISTICS&#10;-- ==============================&#10;&#10;-- Function untuk mendapatkan statistik keseluruhan user&#10;CREATE OR REPLACE FUNCTION get_user_statistics(p_user_id VARCHAR)&#10;RETURNS TABLE(&#10;    total_present BIGINT,&#10;    total_late BIGINT, &#10;    total_absent BIGINT,&#10;    total_meetings BIGINT,&#10;    attendance_percentage NUMERIC&#10;) AS $$&#10;BEGIN&#10;    RETURN QUERY&#10;    SELECT &#10;        COALESCE(SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END), 0) as total_present,&#10;        COALESCE(SUM(CASE WHEN a.status = 'late' THEN 1 ELSE 0 END), 0) as total_late,&#10;        COALESCE(SUM(CASE WHEN a.status = 'absent' THEN 1 ELSE 0 END), 0) as total_absent,&#10;        COALESCE(COUNT(a.attendance_id), 0) as total_meetings,&#10;        COALESCE(&#10;            ROUND(&#10;                SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) * 100.0 / &#10;                NULLIF(COUNT(a.attendance_id), 0), &#10;                2&#10;            ), &#10;            0&#10;        ) as attendance_percentage&#10;    FROM enrollments e&#10;    LEFT JOIN attendances a ON e.enrollment_id = a.enrollment_id&#10;    WHERE e.user_id = p_user_id;&#10;END;&#10;$$ LANGUAGE plpgsql;&#10;&#10;-- Function untuk mendapatkan statistik per mata kuliah&#10;CREATE OR REPLACE FUNCTION get_course_statistics(p_user_id VARCHAR)&#10;RETURNS TABLE(&#10;    course_code VARCHAR,&#10;    course_name VARCHAR,&#10;    total_pertemuan BIGINT,&#10;    hadir BIGINT,&#10;    terlambat BIGINT,&#10;    tidak_hadir BIGINT,&#10;    persentase_kehadiran NUMERIC&#10;) AS $$&#10;BEGIN&#10;    RETURN QUERY&#10;    SELECT &#10;        c.course_code,&#10;        c.course_name,&#10;        COUNT(a.attendance_id) as total_pertemuan,&#10;        SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) as hadir,&#10;        SUM(CASE WHEN a.status = 'late' THEN 1 ELSE 0 END) as terlambat,&#10;        SUM(CASE WHEN a.status = 'absent' THEN 1 ELSE 0 END) as tidak_hadir,&#10;        ROUND(&#10;            SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) * 100.0 / &#10;            NULLIF(COUNT(a.attendance_id), 0), &#10;            2&#10;        ) as persentase_kehadiran&#10;    FROM enrollments e&#10;    JOIN courses c ON e.course_id = c.course_id&#10;    LEFT JOIN attendances a ON e.enrollment_id = a.enrollment_id&#10;    WHERE e.user_id = p_user_id&#10;    GROUP BY c.course_code, c.course_name, c.course_id&#10;    ORDER BY c.course_code;&#10;END;&#10;$$ LANGUAGE plpgsql;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>