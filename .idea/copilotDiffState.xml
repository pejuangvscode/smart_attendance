<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/smartattendance/api/AttendanceApi.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/smartattendance/api/AttendanceApi.kt" />
              <option name="originalContent" value="package com.example.smartattendance.api&#10;&#10;import io.github.jan.supabase.SupabaseClient&#10;import io.github.jan.supabase.postgrest.postgrest&#10;import io.github.jan.supabase.postgrest.query.*&#10;import kotlinx.coroutines.Dispatchers&#10;import kotlinx.coroutines.withContext&#10;import java.time.LocalDate&#10;import java.time.format.DateTimeFormatter&#10;import kotlinx.serialization.Serializable&#10;&#10;class AttendanceApi(private val supabase: SupabaseClient) {&#10;&#10;    // Data class for attendance record&#10;    @Serializable&#10;    data class AttendanceRecord(&#10;        val attendance_id: Int? = null,&#10;        val enrollment_id: Int,&#10;        val schedule_id: Int,&#10;        val attendance_date: String,&#10;        val status: String,&#10;        val is_verified: Boolean = false,&#10;        val recorded_at: String? = null&#10;    )&#10;&#10;    @Serializable&#10;    data class EnrollmentResult(val enrollment_id: Int)&#10;&#10;    @Serializable&#10;    data class AttendanceResult(val attendance_id: Int, val is_verified: Boolean)&#10;&#10;    // Submit attendance - check if exists, if not create, if exists update is_verified&#10;    suspend fun submitAttendance(&#10;        userId: String,&#10;        scheduleId: Int,&#10;        courseId: Int,&#10;        status: String = &quot;present&quot;&#10;    ): Result&lt;String&gt; = withContext(Dispatchers.IO) {&#10;        try {&#10;            // First, get enrollment_id for this user and course&#10;            val enrollmentResult = supabase.postgrest[&quot;enrollments&quot;]&#10;                .select(columns = Columns.list(&quot;enrollment_id&quot;)) {&#10;                    filter {&#10;                        eq(&quot;user_id&quot;, userId)&#10;                        eq(&quot;course_id&quot;, courseId)&#10;                    }&#10;                }&#10;                .decodeList&lt;EnrollmentResult&gt;()&#10;&#10;            if (enrollmentResult.isEmpty()) {&#10;                return@withContext Result.failure(Exception(&quot;User is not enrolled in this course&quot;))&#10;            }&#10;&#10;            val enrollmentId = enrollmentResult.first().enrollment_id&#10;            val today = LocalDate.now().format(DateTimeFormatter.ISO_LOCAL_DATE)&#10;&#10;            // Check if attendance record already exists&#10;            val existingAttendance = supabase.postgrest[&quot;attendances&quot;]&#10;                .select(columns = Columns.list(&quot;attendance_id&quot;, &quot;is_verified&quot;)) {&#10;                    filter {&#10;                        eq(&quot;enrollment_id&quot;, enrollmentId)&#10;                        eq(&quot;schedule_id&quot;, scheduleId)&#10;                        eq(&quot;attendance_date&quot;, today)&#10;                    }&#10;                }&#10;                .decodeList&lt;AttendanceResult&gt;()&#10;&#10;            if (existingAttendance.isNotEmpty()) {&#10;                // Update existing record to verified&#10;                val attendanceId = existingAttendance.first().attendance_id&#10;                supabase.postgrest[&quot;attendances&quot;]&#10;                    .update({&#10;                        set(&quot;is_verified&quot;, true)&#10;                    }) {&#10;                        filter {&#10;                            eq(&quot;attendance_id&quot;, attendanceId)&#10;                        }&#10;                    }&#10;                return@withContext Result.success(&quot;Attendance verified successfully&quot;)&#10;            } else {&#10;                // Create new attendance record&#10;                supabase.postgrest[&quot;attendances&quot;]&#10;                    .insert(AttendanceRecord(&#10;                        enrollment_id = enrollmentId,&#10;                        schedule_id = scheduleId,&#10;                        attendance_date = today,&#10;                        status = status,&#10;                        is_verified = true&#10;                    ))&#10;                return@withContext Result.success(&quot;Attendance submitted successfully&quot;)&#10;            }&#10;        } catch (e: Exception) {&#10;            return@withContext Result.failure(e)&#10;        }&#10;    }&#10;&#10;    // Get attendance status for today&#10;    suspend fun getTodayAttendance(&#10;        userId: String,&#10;        scheduleId: Int,&#10;        courseId: Int&#10;    ): Result&lt;AttendanceRecord?&gt; = withContext(Dispatchers.IO) {&#10;        try {&#10;            // Get enrollment_id&#10;            val enrollmentResult = supabase.postgrest[&quot;enrollments&quot;]&#10;                .select(columns = Columns.list(&quot;enrollment_id&quot;)) {&#10;                    filter {&#10;                        eq(&quot;user_id&quot;, userId)&#10;                        eq(&quot;course_id&quot;, courseId)&#10;                    }&#10;                }&#10;                .decodeList&lt;EnrollmentResult&gt;()&#10;&#10;            if (enrollmentResult.isEmpty()) {&#10;                return@withContext Result.success(null)&#10;            }&#10;&#10;            val enrollmentId = enrollmentResult.first().enrollment_id&#10;            val today = LocalDate.now().format(DateTimeFormatter.ISO_LOCAL_DATE)&#10;&#10;            val attendance = supabase.postgrest[&quot;attendances&quot;]&#10;                .select() {&#10;                    filter {&#10;                        eq(&quot;enrollment_id&quot;, enrollmentId)&#10;                        eq(&quot;schedule_id&quot;, scheduleId)&#10;                        eq(&quot;attendance_date&quot;, today)&#10;                    }&#10;                }&#10;                .decodeList&lt;AttendanceRecord&gt;()&#10;&#10;            return@withContext Result.success(attendance.firstOrNull())&#10;        } catch (e: Exception) {&#10;            return@withContext Result.failure(e)&#10;        }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.smartattendance.api&#10;&#10;import io.github.jan.supabase.SupabaseClient&#10;import io.github.jan.supabase.postgrest.postgrest&#10;import io.github.jan.supabase.postgrest.query.*&#10;import kotlinx.coroutines.Dispatchers&#10;import kotlinx.coroutines.withContext&#10;import java.time.LocalDate&#10;import java.time.format.DateTimeFormatter&#10;import kotlinx.serialization.Serializable&#10;&#10;class AttendanceApi(private val supabase: SupabaseClient) {&#10;&#10;    // Data class for attendance record&#10;    @Serializable&#10;    data class AttendanceRecord(&#10;        val attendance_id: Int? = null,&#10;        val enrollment_id: Int,&#10;        val schedule_id: Int,&#10;        val attendance_date: String,&#10;        val status: String,&#10;        val is_verified: Boolean = false,&#10;        val recorded_at: String? = null&#10;    )&#10;&#10;    @Serializable&#10;    data class EnrollmentResult(val enrollment_id: Int)&#10;&#10;    @Serializable&#10;    data class AttendanceResult(val attendance_id: Int, val is_verified: Boolean)&#10;&#10;    // Submit attendance - check if exists, if not create, if exists update is_verified&#10;    suspend fun submitAttendance(&#10;        userId: String,&#10;        scheduleId: Int,&#10;        courseId: Int,&#10;        status: String = &quot;present&quot;&#10;    ): Result&lt;String&gt; = withContext(Dispatchers.IO) {&#10;        try {&#10;            // First, get enrollment_id for this user and course&#10;            val enrollmentResult = supabase.postgrest[&quot;enrollments&quot;]&#10;                .select(columns = Columns.list(&quot;enrollment_id&quot;)) {&#10;                    filter {&#10;                        eq(&quot;user_id&quot;, userId)&#10;                        eq(&quot;course_id&quot;, courseId)&#10;                    }&#10;                }&#10;                .decodeList&lt;EnrollmentResult&gt;()&#10;&#10;            if (enrollmentResult.isEmpty()) {&#10;                return@withContext Result.failure(Exception(&quot;User is not enrolled in this course&quot;))&#10;            }&#10;&#10;            val enrollmentId = enrollmentResult.first().enrollment_id&#10;            val today = LocalDate.now().format(DateTimeFormatter.ISO_LOCAL_DATE)&#10;&#10;            // Check if attendance record already exists&#10;            val existingAttendance = supabase.postgrest[&quot;attendances&quot;]&#10;                .select(columns = Columns.list(&quot;attendance_id&quot;, &quot;is_verified&quot;)) {&#10;                    filter {&#10;                        eq(&quot;enrollment_id&quot;, enrollmentId)&#10;                        eq(&quot;schedule_id&quot;, scheduleId)&#10;                        eq(&quot;attendance_date&quot;, today)&#10;                    }&#10;                }&#10;                .decodeList&lt;AttendanceResult&gt;()&#10;&#10;            if (existingAttendance.isNotEmpty()) {&#10;                // Update existing record to verified&#10;                val attendanceId = existingAttendance.first().attendance_id&#10;                supabase.postgrest[&quot;attendances&quot;]&#10;                    .update({&#10;                        set(&quot;is_verified&quot;, true)&#10;                    }) {&#10;                        filter {&#10;                            eq(&quot;attendance_id&quot;, attendanceId)&#10;                        }&#10;                    }&#10;                return@withContext Result.success(&quot;Attendance verified successfully&quot;)&#10;            } else {&#10;                // Create new attendance record with is_verified = false&#10;                supabase.postgrest[&quot;attendances&quot;]&#10;                    .insert(AttendanceRecord(&#10;                        enrollment_id = enrollmentId,&#10;                        schedule_id = scheduleId,&#10;                        attendance_date = today,&#10;                        status = status,&#10;                        is_verified = false&#10;                    ))&#10;                return@withContext Result.success(&quot;Attendance submitted, waiting for verification&quot;)&#10;            }&#10;        } catch (e: Exception) {&#10;            return@withContext Result.failure(e)&#10;        }&#10;    }&#10;&#10;    // Get attendance status for today&#10;    suspend fun getTodayAttendance(&#10;        userId: String,&#10;        scheduleId: Int,&#10;        courseId: Int&#10;    ): Result&lt;AttendanceRecord?&gt; = withContext(Dispatchers.IO) {&#10;        try {&#10;            // Get enrollment_id&#10;            val enrollmentResult = supabase.postgrest[&quot;enrollments&quot;]&#10;                .select(columns = Columns.list(&quot;enrollment_id&quot;)) {&#10;                    filter {&#10;                        eq(&quot;user_id&quot;, userId)&#10;                        eq(&quot;course_id&quot;, courseId)&#10;                    }&#10;                }&#10;                .decodeList&lt;EnrollmentResult&gt;()&#10;&#10;            if (enrollmentResult.isEmpty()) {&#10;                return@withContext Result.success(null)&#10;            }&#10;&#10;            val enrollmentId = enrollmentResult.first().enrollment_id&#10;            val today = LocalDate.now().format(DateTimeFormatter.ISO_LOCAL_DATE)&#10;&#10;            val attendance = supabase.postgrest[&quot;attendances&quot;]&#10;                .select() {&#10;                    filter {&#10;                        eq(&quot;enrollment_id&quot;, enrollmentId)&#10;                        eq(&quot;schedule_id&quot;, scheduleId)&#10;                        eq(&quot;attendance_date&quot;, today)&#10;                    }&#10;                }&#10;                .decodeList&lt;AttendanceRecord&gt;()&#10;&#10;            return@withContext Result.success(attendance.firstOrNull())&#10;        } catch (e: Exception) {&#10;            return@withContext Result.failure(e)&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/database_functions.sql">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/database_functions.sql" />
              <option name="updatedContent" value="-- ==============================&#10;-- STORED PROCEDURES FOR STATISTICS&#10;-- ==============================&#10;&#10;-- Function untuk mendapatkan statistik keseluruhan user&#10;CREATE OR REPLACE FUNCTION get_user_statistics(p_user_id VARCHAR)&#10;RETURNS TABLE(&#10;    total_present BIGINT,&#10;    total_late BIGINT, &#10;    total_absent BIGINT,&#10;    total_meetings BIGINT,&#10;    attendance_percentage NUMERIC&#10;) AS $$&#10;BEGIN&#10;    RETURN QUERY&#10;    SELECT &#10;        COALESCE(SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END), 0) as total_present,&#10;        COALESCE(SUM(CASE WHEN a.status = 'late' THEN 1 ELSE 0 END), 0) as total_late,&#10;        COALESCE(SUM(CASE WHEN a.status = 'absent' THEN 1 ELSE 0 END), 0) as total_absent,&#10;        COALESCE(COUNT(a.attendance_id), 0) as total_meetings,&#10;        COALESCE(&#10;            ROUND(&#10;                SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) * 100.0 / &#10;                NULLIF(COUNT(a.attendance_id), 0), &#10;                2&#10;            ), &#10;            0&#10;        ) as attendance_percentage&#10;    FROM enrollments e&#10;    LEFT JOIN attendances a ON e.enrollment_id = a.enrollment_id&#10;    WHERE e.user_id = p_user_id;&#10;END;&#10;$$ LANGUAGE plpgsql;&#10;&#10;-- Function untuk mendapatkan statistik per mata kuliah&#10;CREATE OR REPLACE FUNCTION get_course_statistics(p_user_id VARCHAR)&#10;RETURNS TABLE(&#10;    course_code VARCHAR,&#10;    course_name VARCHAR,&#10;    total_pertemuan BIGINT,&#10;    hadir BIGINT,&#10;    terlambat BIGINT,&#10;    tidak_hadir BIGINT,&#10;    persentase_kehadiran NUMERIC&#10;) AS $$&#10;BEGIN&#10;    RETURN QUERY&#10;    SELECT &#10;        c.course_code,&#10;        c.course_name,&#10;        COUNT(a.attendance_id) as total_pertemuan,&#10;        SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) as hadir,&#10;        SUM(CASE WHEN a.status = 'late' THEN 1 ELSE 0 END) as terlambat,&#10;        SUM(CASE WHEN a.status = 'absent' THEN 1 ELSE 0 END) as tidak_hadir,&#10;        ROUND(&#10;            SUM(CASE WHEN a.status = 'present' THEN 1 ELSE 0 END) * 100.0 / &#10;            NULLIF(COUNT(a.attendance_id), 0), &#10;            2&#10;        ) as persentase_kehadiran&#10;    FROM enrollments e&#10;    JOIN courses c ON e.course_id = c.course_id&#10;    LEFT JOIN attendances a ON e.enrollment_id = a.enrollment_id&#10;    WHERE e.user_id = p_user_id&#10;    GROUP BY c.course_code, c.course_name, c.course_id&#10;    ORDER BY c.course_code;&#10;END;&#10;$$ LANGUAGE plpgsql;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>